# TimeLine

- [x] 框架
  - [x] config文件的创建和读取
  - [x] 读取照片
    - [x] 找到两个数据集中相同的照片
    - [x] 根据照片名字得到car pose和camera pose
    - [x] 设置内参矩阵
    - [x] 按顺序读取某一个record的照片
    - [x] 返回函数：返回一个字典(包含camera pose, 是否有car pose，id, rgb图, 深度图等信息)
  - [x] 创建多个线程
  
- [ ] 优化线程
  - [x] theseus图优化数据结构
  - [ ] theseus图优化计算函数 
  
- [x] 读取apollo数据集
  
- [ ] 将nerfstudio嵌入框架
  - [x] 尝试单进程融入
  
  - [x] 解决nerfstudio_collate.py问题
  
    在主进程调用nerfstudio就可以运行，但是在子进程不行(原因应该是pytorch的问题)
  
  - [x] 学习如何单独调用nerfstudio各个模块
  
  - [ ] 将读取数据集修改为nerfstudio的datamanager
  
  - [ ] 将已有的background模型改写进nerfstudio
  
     - [ ] 改写BackgroundSdfTcnn类，geometry网络用于生成sdf和sdf特征
  
     - [ ] 改写BackgroundRgbTcnn类，color网络用语生成color
  
     - [ ] 改写variance类，用语计算方差
  
     - [ ] 整合上面3个类改写background类，写传播函数
  
  - [ ] 添加损失函数到nerfstudio.base_surface_model.surfacemodel
  
  - [ ] 将optimizer的设置移动到nerfstudio.trainer.setup()中
  
  - [ ] 寻找对应的config，并修改到nerfstudio中对应的类config中去
  
  - [ ] 把obj-rendering换成[ssd-nerf](https://github.com/Lakonik/SSDNeRF)
  


# 环境配置

```shell
# 基本环境
pip install cython # 安装apollo数据集自带的库需要用到(在car_instance文件夹中安装)
# 安装apollo数据集的c++库需要sudo,如果和当前conda环境不一致需要用如下命令安装
sudo -E env "PATH=$PATH" bash install.sh
conda install pytorch torchvision torchaudio pytorch-cuda=11.8 -c pytorch -c nvidia
pip install numpy scipy matplotlib 
pip install opencv-python

# 安装theseus
## 安装前置库Dispenso,OpenBLAS,BaSpaCho
## 都只用sudo make install安装即可
## 从git官网下载最新版本theseus
git clone https://github.com/facebookresearch/theseus.git && cd theseus
BASPACHO_ROOT_DIR=/home/yang/3rdLibrary/baspacho pip install -e .
```



# 运行

```
python slam_system.py --config ./configs/apollo.yaml
```

# Debug

- 创建launch.json

  ```json
  {
      // Use IntelliSense to learn about possible attributes.
      // Hover to view descriptions of existing attributes.
      // For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387
      "version": "0.2.0",
      "configurations": [
          {
              "name": "Python: Current File",
              "type": "python",
              "request": "launch",
              "program": "${file}",
              "console": "integratedTerminal",
              "justMyCode": true,
              "args": [
                  "--config","./configs/apollo.yaml"
              ]
          }
      ]
  }
  ```

- 对主文件slam_system.py进行debug



# 3rdLib

## NerfStudio

### 1. 安装

参照[git官网](https://github.com/nerfstudio-project/nerfstudio/)来安装：

1. 在conda环境中安装python>=3.8和cuda11.8

2. 安装tiny-cuda-nn

   ```shell
   conda install -c "nvidia/label/cuda-11.8.0" cuda-toolkit
   pip install ninja git+https://github.com/NVlabs/tiny-cuda-nn/#subdirectory=bindings/torch
   ```

3. 下载安装nerfstudio

   ```shell
   git clone https://github.com/nerfstudio-project/nerfstudio.git
   cd nerfstudio
   pip install --upgrade pip setuptools
   pip install -e .
   ```

### 2. 运行

使用nerfacto

```shell
# Download some test data:
ns-download-data nerfstudio --capture-name=poster
# Train model
ns-train nerfacto --data dataset/nerfstudio/poster
# 根据pyproject.toml可知，这里的ns-train就是调用了nerfstudio.scripts.train这个.py文件
# 所以运行如下命令一样可以训练
python train.py nerfacto --data ../../dataset/nerfstudio/poster 
```

使用neusfacto

```shell
# 下载数据集
ns-download-data sdfstudio --dataset-name sdfstudio-demo-data
# 训练模型
ns-train neus-facto --pipeline.model.sdf-field.inside-outside=False sdfstudio-data --data=dataset/sdfstudio-demo-data/dtu-scan65
# 直接用.py
python train.py neus-facto --pipeline.model.sdf-field.inside-outside=False sdfstudio-data --data=/home/yang/Desktop/MasterThesis_BA_for_SC/dataset/sdfstudio-demo-data/dtu-scan65
# 使用背景

```

- 对于基于sdf的模型如neusfacto和neus，需要对客户数据进行预处理

  参考[issue1732](https://github.com/nerfstudio-project/nerfstudio/issues/1732#:~:text=Hi%20so%20you,get%20things%20preprocessed.)

- 关于nerfacto和neusfacto通用dataset的一些讨论：[issue2023](https://github.com/nerfstudio-project/nerfstudio/issues/2023)

#### 2.1 cofig输出

```shell
TrainerConfig(
    _target=<class 'nerfstudio.engine.trainer.Trainer'>,
    output_dir=PosixPath('outputs'),
    method_name='neus-facto',
    experiment_name=None,
    project_name='nerfstudio-project',
    timestamp='2024',
    machine=MachineConfig(seed=42, num_devices=1, num_machines=1, machine_rank=0, dist_url='auto', device_type='cuda'),
    logging=LoggingConfig(
        relative_log_dir=PosixPath('.'),
        steps_per_log=10,
        max_buffer_size=20,
        local_writer=LocalWriterConfig(
            _target=<class 'nerfstudio.utils.writer.LocalWriter'>,
            enable=True,
            stats_to_track=(
                <EventName.ITER_TRAIN_TIME: 'Train Iter (time)'>,
                <EventName.TRAIN_RAYS_PER_SEC: 'Train Rays / Sec'>,
                <EventName.CURR_TEST_PSNR: 'Test PSNR'>,
                <EventName.VIS_RAYS_PER_SEC: 'Vis Rays / Sec'>,
                <EventName.TEST_RAYS_PER_SEC: 'Test Rays / Sec'>,
                <EventName.ETA: 'ETA (time)'>
            ),
            max_log_size=10
        ),
        profiler='basic'
    ),
    viewer=ViewerConfig(
        relative_log_filename='viewer_log_filename.txt',
        websocket_port=None,
        websocket_port_default=7007,
        websocket_host='0.0.0.0',
        num_rays_per_chunk=32768,
        max_num_display_images=512,
        quit_on_train_completion=False,
        image_format='jpeg',
        jpeg_quality=75,
        make_share_url=False,
        camera_frustum_scale=0.1,
        default_composite_depth=True
    ),
    pipeline=VanillaPipelineConfig(
        _target=<class 'nerfstudio.pipelines.base_pipeline.VanillaPipeline'>,
        datamanager=VanillaDataManagerConfig(
            _target=nerfstudio.data.datamanagers.base_datamanager.VanillaDataManager[nerfstudio.data.datasets.sdf_datase
t.SDFDataset],
            data=PosixPath('/home/yang/Desktop/SLAM_Code_Learning/nerfstudio/data/sdfstudio-demo-data/dtu-scan65'),
            masks_on_gpu=False,
            images_on_gpu=False,
            dataparser=SDFStudioDataParserConfig(
                _target=<class 'nerfstudio.data.dataparsers.sdfstudio_dataparser.SDFStudio'>,
                data=PosixPath('data/DTU/scan65'),
                include_mono_prior=False,
                depth_unit_scale_factor=0.001,
                include_foreground_mask=False,
                downscale_factor=1,
                scene_scale=2.0,
                skip_every_for_val_split=1,
                auto_orient=True
            ),
            train_num_rays_per_batch=2048,
            train_num_images_to_sample_from=-1,
            train_num_times_to_repeat_images=-1,
            eval_num_rays_per_batch=2048,
            eval_num_images_to_sample_from=-1,
            eval_num_times_to_repeat_images=-1,
            eval_image_indices=(0,),
            collate_fn=<function nerfstudio_collate at 0x7fcb88e56940>,
            camera_res_scale_factor=1.0,
            patch_size=1,
            camera_optimizer=None,
            pixel_sampler=PixelSamplerConfig(
                _target=<class 'nerfstudio.data.pixel_samplers.PixelSampler'>,
                num_rays_per_batch=4096,
                keep_full_image=False,
                is_equirectangular=False,
                ignore_mask=False,
                fisheye_crop_radius=None,
                rejection_sample_mask=True,
                max_num_iterations=100
            )
        ),
        model=NeuSFactoModelConfig(
            _target=<class 'nerfstudio.models.neus_facto.NeuSFactoModel'>,
            enable_collider=True,
            collider_params={'near_plane': 2.0, 'far_plane': 6.0},
            loss_coefficients={'rgb_loss_coarse': 1.0, 'rgb_loss_fine': 1.0},
            eval_num_rays_per_chunk=2048,
            prompt=None,
            near_plane=0.05,
            far_plane=4.0,
            far_plane_bg=1000.0,
            background_color='black',
            use_average_appearance_embedding=False,
            eikonal_loss_mult=0.1,
            fg_mask_loss_mult=0.01,
            mono_normal_loss_mult=0.0,
            mono_depth_loss_mult=0.0,
            sdf_field=SDFFieldConfig(
                _target=<class 'nerfstudio.fields.sdf_field.SDFField'>,
                num_layers=2,
                hidden_dim=256,
                geo_feat_dim=256,
                num_layers_color=2,
                hidden_dim_color=256,
                appearance_embedding_dim=32,
                use_appearance_embedding=False,
                bias=0.5,
                geometric_init=True,
                inside_outside=False,
                weight_norm=True,
                use_grid_feature=True,
                divide_factor=2.0,
                beta_init=0.8,
                encoding_type='hash',
                num_levels=16,
                max_res=2048,
                base_res=16,
                log2_hashmap_size=19,
                features_per_level=2,
                use_hash=True,
                smoothstep=True
            ),
            background_model='none',
            num_samples_outside=32,
            periodic_tvl_mult=0.0,
            overwrite_near_far_plane=False,
            num_samples=64,
            num_samples_importance=64,
            num_up_sample_steps=4,
            base_variance=64,
            perturb=True,
            num_proposal_samples_per_ray=(256, 96),
            num_neus_samples_per_ray=48,
            proposal_update_every=5,
            proposal_warmup=5000,
            num_proposal_iterations=2,
            use_same_proposal_network=False,
            proposal_net_args_list=[
                {'hidden_dim': 16, 'log2_hashmap_size': 17, 'num_levels': 5, 'max_res': 64},
                {'hidden_dim': 16, 'log2_hashmap_size': 17, 'num_levels': 5, 'max_res': 256}
            ],
            interlevel_loss_mult=1.0,
            use_proposal_weight_anneal=True,
            proposal_weights_anneal_slope=10.0,
            proposal_weights_anneal_max_num_iters=1000,
            use_single_jitter=True
        )
    ),
    optimizers={
        'proposal_networks': {
            'optimizer': AdamOptimizerConfig(
                _target=<class 'torch.optim.adam.Adam'>,
                lr=0.01,
                eps=1e-15,
                max_norm=None,
                weight_decay=0
            ),
            'scheduler': MultiStepSchedulerConfig(
                _target=<class 'nerfstudio.engine.schedulers.MultiStepScheduler'>,
                max_steps=201,
                gamma=0.33,
                milestones=(100, 15, 180)
            )
        },
        'fields': {
            'optimizer': AdamOptimizerConfig(
                _target=<class 'torch.optim.adam.Adam'>,
                lr=0.0005,
                eps=1e-15,
                max_norm=None,
                weight_decay=0
            ),
            'scheduler': CosineDecaySchedulerConfig(
                _target=<class 'nerfstudio.engine.schedulers.CosineDecayScheduler'>,
                warm_up_end=5,
                learning_rate_alpha=0.05,
                max_steps=201
            )
        },
        'field_background': {
            'optimizer': AdamOptimizerConfig(
                _target=<class 'torch.optim.adam.Adam'>,
                lr=0.0005,
                eps=1e-15,
                max_norm=None,
                weight_decay=0
            ),
            'scheduler': CosineDecaySchedulerConfig(
                _target=<class 'nerfstudio.engine.schedulers.CosineDecayScheduler'>,
                warm_up_end=5,
                learning_rate_alpha=0.05,
                max_steps=201
            )
        }
    },
    vis='viewer',
    data=PosixPath('/home/yang/Desktop/SLAM_Code_Learning/nerfstudio/data/sdfstudio-demo-data/dtu-scan65'),
    prompt=None,
    relative_model_dir=PosixPath('nerfstudio_models'),
    load_scheduler=True,
    steps_per_save=20,
    steps_per_eval_batch=50,
    steps_per_eval_image=50,
    steps_per_eval_all_images=1000000,
    max_num_iterations=201,
    mixed_precision=False,
    use_grad_scaler=False,
    save_only_latest_checkpoint=True,
    load_dir=None,
    load_step=None,
    load_config=None,
    load_checkpoint=None,
    log_gradients=False,
    gradient_accumulation_steps={}
)
```

#### 2.2 --help输出

`ns-train neus-facto --help`

```shell
usage: ns-train neus-facto [-h] [NEUS-FACTO OPTIONS]
                           [{nerfstudio-data,minimal-parser,arkit-data,blender-data,instant-ngp-data,nuscenes-data,d
nerf-data,phototourism-data,dycheck-data,scannet-data,sdfstudio-data,nerfosr-data,sitcoms3d-data,scannetpp-data,colm
ap}]

Implementation of NeuS-Facto. (slow)

╭─ options ────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ -h, --help              show this help message and exit                                                          │
│ --output-dir PATH       relative or absolute output directory to save all checkpoints and logging (default:      │
│                         outputs)                                                                                 │
│ --method-name {None}|STR                                                                                         │
│                         Method name. Required to set in python or via cli (default: neus-facto)                  │
│ --experiment-name {None}|STR                                                                                     │
│                         Experiment name. If None, will automatically be set to dataset name (default: None)      │
│ --project-name {None}|STR                                                                                        │
│                         Project name. (default: nerfstudio-project)                                              │
│ --timestamp STR         Experiment timestamp. (default: '{timestamp}')                                           │
│ --vis {viewer,wandb,tensorboard,comet,viewer+wandb,viewer+tensorboard,viewer+comet,viewer_legacy}                │
│                         Which visualizer to use. (default: viewer)                                               │
│ --data {None}|PATH      Alias for --pipeline.datamanager.data (default: None)                                    │
│ --prompt {None}|STR     Alias for --pipeline.model.prompt (default: None)                                        │
│ --relative-model-dir PATH                                                                                        │
│                         Relative path to save all checkpoints. (default: nerfstudio_models)                      │
│ --load-scheduler {True,False}                                                                                    │
│                         Whether to load the scheduler state_dict to resume training, if it exists. (default:     │
│                         True)                                                                                    │
│ --steps-per-save INT    Number of steps between saves. (default: 2000)                                           │
│ --steps-per-eval-batch INT                                                                                       │
│                         Number of steps between randomly sampled batches of rays. (default: 5000)                │
│ --steps-per-eval-image INT                                                                                       │
│                         Number of steps between single eval images. (default: 5000)                              │
│ --steps-per-eval-all-images INT                                                                                  │
│                         Number of steps between eval all images. (default: 1000000)                              │
│ --max-num-iterations INT                                                                                         │
│                         Maximum number of iterations to run. (default: 20001)                                    │
│ --mixed-precision {True,False}                                                                                   │
│                         Whether or not to use mixed precision for training. (default: False)                     │
│ --use-grad-scaler {True,False}                                                                                   │
│                         Use gradient scaler even if the automatic mixed precision is disabled. (default: False)  │
│ --save-only-latest-checkpoint {True,False}                                                                       │
│                         Whether to only save the latest checkpoint or all checkpoints. (default: True)           │
│ --load-dir {None}|PATH  Optionally specify a pre-trained model directory to load from. (default: None)           │
│ --load-step {None}|INT  Optionally specify model step to load from; if none, will find most recent model in      │
│                         load_dir. (default: None)                                                                │
│ --load-config {None}|PATH                                                                                        │
│                         Path to config YAML file. (default: None)                                                │
│ --load-checkpoint {None}|PATH                                                                                    │
│                         Path to checkpoint file. (default: None)                                                 │
│ --log-gradients {True,False}                                                                                     │
│                         Optionally log gradients during training (default: False)                                │
│ --gradient-accumulation-steps [STR STR [STR STR ...]]                                                            │
│                         Number of steps to accumulate gradients over. Contains a mapping of {param_group:num}    │
│                         (default: )                                                                              │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─ machine options ────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Machine configuration                                                                                            │
│ ──────────────────────────────────────────────────────────────────────────────────────────────────────────────── │
│ --machine.seed INT      random seed initialization (default: 42)                                                 │
│ --machine.num-devices INT                                                                                        │
│                         total number of devices (e.g., gpus) available for train/eval (default: 1)               │
│ --machine.num-machines INT                                                                                       │
│                         total number of distributed machines available (for DDP) (default: 1)                    │
│ --machine.machine-rank INT                                                                                       │
│                         current machine's rank (for DDP) (default: 0)                                            │
│ --machine.dist-url STR  distributed connection point (for DDP) (default: auto)                                   │
│ --machine.device-type {cpu,cuda,mps}                                                                             │
│                         device type to use for training (default: cuda)                                          │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─ logging options ────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Logging configuration                                                                                            │
│ ──────────────────────────────────────────────────────────────────────────────────────────────────────────────── │
│ --logging.relative-log-dir PATH                                                                                  │
│                         relative path to save all logged events (default: .)                                     │
│ --logging.steps-per-log INT                                                                                      │
│                         number of steps between logging stats (default: 10)                                      │
│ --logging.max-buffer-size INT                                                                                    │
│                         maximum history size to keep for computing running averages of stats. e.g. if 20,        │
│                         averages will be computed over past 20 occurrences. (default: 20)                        │
│ --logging.profiler {none,basic,pytorch}                                                                          │
│                         how to profile the code;                                                                 │
│                         "basic" - prints speed of all decorated functions at the end of a program.               │
│                         "pytorch" - same as basic, but it also traces few training steps. (default: basic)       │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─ logging.local-writer options ───────────────────────────────────────────────────────────────────────────────────╮
│ if provided, will print stats locally. if None, will disable printing                                            │
│ ──────────────────────────────────────────────────────────────────────────────────────────────────────────────── │
│ --logging.local-writer.enable {True,False}                                                                       │
│                         if True enables local logging, else disables (default: True)                             │
│ --logging.local-writer.stats-to-track                                                                            │
│ [{ITER_TRAIN_TIME,TOTAL_TRAIN_TIME,ETA,TRAIN_RAYS_PER_SEC,TEST_RAYS_PER_SEC,VIS_RAYS_PER_SEC,CURR_TEST_PSNR}     │
│ [...]]                                                                                                           │
│                         specifies which stats will be logged/printed to terminal (default: ITER_TRAIN_TIME       │
│                         TRAIN_RAYS_PER_SEC CURR_TEST_PSNR VIS_RAYS_PER_SEC TEST_RAYS_PER_SEC ETA)                │
│ --logging.local-writer.max-log-size INT                                                                          │
│                         maximum number of rows to print before wrapping. if 0, will print everything. (default:  │
│                         10)                                                                                      │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─ viewer options ─────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Viewer configuration                                                                                             │
│ ──────────────────────────────────────────────────────────────────────────────────────────────────────────────── │
│ --viewer.relative-log-filename STR                                                                               │
│                         Filename to use for the log file. (default: viewer_log_filename.txt)                     │
│ --viewer.websocket-port {None}|INT                                                                               │
│                         The websocket port to connect to. If None, find an available port. (default: None)       │
│ --viewer.websocket-port-default INT                                                                              │
│                         The default websocket port to connect to if websocket_port is not specified (default:    │
│                         7007)                                                                                    │
│ --viewer.websocket-host STR                                                                                      │
│                         The host address to bind the websocket server to. (default: 0.0.0.0)                     │
│ --viewer.num-rays-per-chunk INT                                                                                  │
│                         number of rays per chunk to render with viewer (default: 32768)                          │
│ --viewer.max-num-display-images INT                                                                              │
│                         Maximum number of training images to display in the viewer, to avoid lag. This does not  │
│                         change which images are actually used in training/evaluation. If -1, display all.        │
│                         (default: 512)                                                                           │
│ --viewer.quit-on-train-completion {True,False}                                                                   │
│                         Whether to kill the training job when it has completed. Note this will stop rendering in │
│                         the viewer. (default: False)                                                             │
│ --viewer.image-format {jpeg,png}                                                                                 │
│                         Image format viewer should use; jpeg is lossy compression, while png is lossless.        │
│                         (default: jpeg)                                                                          │
│ --viewer.jpeg-quality INT                                                                                        │
│                         Quality tradeoff to use for jpeg compression. (default: 75)                              │
│ --viewer.make-share-url {True,False}                                                                             │
│                         Viewer beta feature: print a shareable URL. `vis` must be set to viewer_beta; this flag  │
│                         is otherwise ignored. (default: False)                                                   │
│ --viewer.camera-frustum-scale FLOAT                                                                              │
│                         Scale for the camera frustums in the viewer. (default: 0.1)                              │
│ --viewer.default-composite-depth {True,False}                                                                    │
│                         The default value for compositing depth. Turn off if you want to see the camera frustums │
│                         without occlusions. (default: True)                                                      │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─ pipeline.datamanager options ───────────────────────────────────────────────────────────────────────────────────╮
│ specifies the datamanager config                                                                                 │
│ ──────────────────────────────────────────────────────────────────────────────────────────────────────────────── │
│ --pipeline.datamanager.data {None}|PATH                                                                          │
│                         Source of data, may not be used by all models. (default: None)                           │
│ --pipeline.datamanager.masks-on-gpu {True,False}                                                                 │
│                         Process masks on GPU for speed at the expense of memory, if True. (default: False)       │
│ --pipeline.datamanager.images-on-gpu {True,False}                                                                │
│                         Process images on GPU for speed at the expense of memory, if True. (default: False)      │
│ --pipeline.datamanager.train-num-rays-per-batch INT                                                              │
│                         Number of rays per batch to use per training iteration. (default: 2048)                  │
│ --pipeline.datamanager.train-num-images-to-sample-from INT                                                       │
│                         Number of images to sample during training iteration. (default: -1)                      │
│ --pipeline.datamanager.train-num-times-to-repeat-images INT                                                      │
│                         When not training on all images, number of iterations before picking new images. If -1,  │
│                         never pick new images. (default: -1)                                                     │
│ --pipeline.datamanager.eval-num-rays-per-batch INT                                                               │
│                         Number of rays per batch to use per eval iteration. (default: 2048)                      │
│ --pipeline.datamanager.eval-num-images-to-sample-from INT                                                        │
│                         Number of images to sample during eval iteration. (default: -1)                          │
│ --pipeline.datamanager.eval-num-times-to-repeat-images INT                                                       │
│                         When not evaluating on all images, number of iterations before picking new images. If    │
│                         -1, never pick new images. (default: -1)                                                 │
│ --pipeline.datamanager.eval-image-indices {None}|{[INT [INT ...]]}                                               │
│                         Specifies the image indices to use during eval; if None, uses all. (default: 0)          │
│ --pipeline.datamanager.camera-res-scale-factor FLOAT                                                             │
│                         The scale factor for scaling spatial data such as images, mask, semantics along with     │
│                         relevant information about camera intrinsics (default: 1.0)                              │
│ --pipeline.datamanager.patch-size INT                                                                            │
│                         Size of patch to sample from. If > 1, patch-based sampling will be used. (default: 1)    │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─ pipeline.datamanager.pixel-sampler options ─────────────────────────────────────────────────────────────────────╮
│ Specifies the pixel sampler used to sample pixels from images.                                                   │
│ ──────────────────────────────────────────────────────────────────────────────────────────────────────────────── │
│ --pipeline.datamanager.pixel-sampler.num-rays-per-batch INT                                                      │
│                         Number of rays to sample per batch. (default: 4096)                                      │
│ --pipeline.datamanager.pixel-sampler.keep-full-image {True,False}                                                │
│                         Whether or not to include a reference to the full image in returned batch. (default:     │
│                         False)                                                                                   │
│ --pipeline.datamanager.pixel-sampler.is-equirectangular {True,False}                                             │
│                         List of whether or not camera i is equirectangular. (default: False)                     │
│ --pipeline.datamanager.pixel-sampler.fisheye-crop-radius {None}|FLOAT                                            │
│                         Set to the radius (in pixels) for fisheye cameras. (default: None)                       │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─ pipeline.model options ─────────────────────────────────────────────────────────────────────────────────────────╮
│ specifies the model config                                                                                       │
│ ──────────────────────────────────────────────────────────────────────────────────────────────────────────────── │
│ --pipeline.model.enable-collider {True,False}                                                                    │
│                         Whether to create a scene collider to filter rays. (default: True)                       │
│ --pipeline.model.collider-params {None}|{[STR FLOAT [STR FLOAT ...]]}                                            │
│                         parameters to instantiate scene collider with (default: near_plane 2.0 far_plane 6.0)    │
│ --pipeline.model.eval-num-rays-per-chunk INT                                                                     │
│                         specifies number of rays per chunk during eval (default: 2048)                           │
│ --pipeline.model.prompt {None}|STR                                                                               │
│                         A prompt to be used in text to NeRF models (default: None)                               │
│ --pipeline.model.near-plane FLOAT                                                                                │
│                         How far along the ray to start sampling. (default: 0.05)                                 │
│ --pipeline.model.far-plane FLOAT                                                                                 │
│                         How far along the ray to stop sampling. (default: 4.0)                                   │
│ --pipeline.model.far-plane-bg FLOAT                                                                              │
│                         How far along the ray to stop sampling of the background model. (default: 1000.0)        │
│ --pipeline.model.background-color {random,last_sample,white,black}                                               │
│                         Whether to randomize the background color. (default: black)                              │
│ --pipeline.model.use-average-appearance-embedding {True,False}                                                   │
│                         Whether to use average appearance embedding or zeros for inference. (default: False)     │
│ --pipeline.model.eikonal-loss-mult FLOAT                                                                         │
│                         Monocular normal consistency loss multiplier. (default: 0.1)                             │
│ --pipeline.model.fg-mask-loss-mult FLOAT                                                                         │
│                         Foreground mask loss multiplier. (default: 0.01)                                         │
│ --pipeline.model.mono-normal-loss-mult FLOAT                                                                     │
│                         Monocular normal consistency loss multiplier. (default: 0.0)                             │
│ --pipeline.model.mono-depth-loss-mult FLOAT                                                                      │
│                         Monocular depth consistency loss multiplier. (default: 0.0)                              │
│ --pipeline.model.background-model {grid,mlp,none}                                                                │
│                         background models (default: none)                                                        │
│ --pipeline.model.num-samples-outside INT                                                                         │
│                         Number of samples outside the bounding sphere for background (default: 32)               │
│ --pipeline.model.periodic-tvl-mult FLOAT                                                                         │
│                         Total variational loss multiplier (default: 0.0)                                         │
│ --pipeline.model.overwrite-near-far-plane {True,False}                                                           │
│                         whether to use near and far collider from command line (default: False)                  │
│ --pipeline.model.num-samples INT                                                                                 │
│                         Number of uniform samples (default: 64)                                                  │
│ --pipeline.model.num-samples-importance INT                                                                      │
│                         Number of importance samples (default: 64)                                               │
│ --pipeline.model.num-up-sample-steps INT                                                                         │
│                         number of up sample step, 1 for simple coarse-to-fine sampling (default: 4)              │
│ --pipeline.model.base-variance FLOAT                                                                             │
│                         fixed base variance in NeuS sampler, the inv_s will be base * 2 ** iter during upsample  │
│                         (default: 64)                                                                            │
│ --pipeline.model.perturb {True,False}                                                                            │
│                         use to use perturb for the sampled points (default: True)                                │
│ --pipeline.model.num-proposal-samples-per-ray [INT [INT ...]]                                                    │
│                         Number of samples per ray for the proposal network. (default: 256 96)                    │
│ --pipeline.model.num-neus-samples-per-ray INT                                                                    │
│                         Number of samples per ray for the nerf network. (default: 48)                            │
│ --pipeline.model.proposal-update-every INT                                                                       │
│                         Sample every n steps after the warmup (default: 5)                                       │
│ --pipeline.model.proposal-warmup INT                                                                             │
│                         Scales n from 1 to proposal_update_every over this many steps (default: 5000)            │
│ --pipeline.model.num-proposal-iterations INT                                                                     │
│                         Number of proposal network iterations. (default: 2)                                      │
│ --pipeline.model.use-same-proposal-network {True,False}                                                          │
│                         Use the same proposal network. Otherwise use different ones. (default: False)            │
│ --pipeline.model.interlevel-loss-mult FLOAT                                                                      │
│                         Proposal loss multiplier. (default: 1.0)                                                 │
│ --pipeline.model.use-proposal-weight-anneal {True,False}                                                         │
│                         Whether to use proposal weight annealing. (default: True)                                │
│ --pipeline.model.proposal-weights-anneal-slope FLOAT                                                             │
│                         Slope of the annealing function for the proposal weights. (default: 10.0)                │
│ --pipeline.model.proposal-weights-anneal-max-num-iters INT                                                       │
│                         Max num iterations for the annealing function. (default: 1000)                           │
│ --pipeline.model.use-single-jitter {True,False}                                                                  │
│                         Whether use single jitter or not for the proposal networks. (default: True)              │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─ pipeline.model.loss-coefficients options ───────────────────────────────────────────────────────────────────────╮
│ parameters to instantiate density field with                                                                     │
│ ──────────────────────────────────────────────────────────────────────────────────────────────────────────────── │
│ --pipeline.model.loss-coefficients.rgb-loss-coarse FLOAT                                                         │
│                         (default: 1.0)                                                                           │
│ --pipeline.model.loss-coefficients.rgb-loss-fine FLOAT                                                           │
│                         (default: 1.0)                                                                           │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─ pipeline.model.sdf-field options ───────────────────────────────────────────────────────────────────────────────╮
│ Config for SDF Field                                                                                             │
│ ──────────────────────────────────────────────────────────────────────────────────────────────────────────────── │
│ --pipeline.model.sdf-field.num-layers INT                                                                        │
│                         Number of layers for geometric network (default: 2)                                      │
│ --pipeline.model.sdf-field.hidden-dim INT                                                                        │
│                         Number of hidden dimension of geometric network (default: 256)                           │
│ --pipeline.model.sdf-field.geo-feat-dim INT                                                                      │
│                         Dimension of geometric feature (default: 256)                                            │
│ --pipeline.model.sdf-field.num-layers-color INT                                                                  │
│                         Number of layers for color network (default: 2)                                          │
│ --pipeline.model.sdf-field.hidden-dim-color INT                                                                  │
│                         Number of hidden dimension of color network (default: 256)                               │
│ --pipeline.model.sdf-field.appearance-embedding-dim INT                                                          │
│                         Dimension of appearance embedding (default: 32)                                          │
│ --pipeline.model.sdf-field.use-appearance-embedding {True,False}                                                 │
│                         Whether to use appearance embedding (default: False)                                     │
│ --pipeline.model.sdf-field.bias FLOAT                                                                            │
│                         Sphere size of geometric initialization (default: 0.5)                                   │
│ --pipeline.model.sdf-field.geometric-init {True,False}                                                           │
│                         Whether to use geometric initialization (default: True)                                  │
│ --pipeline.model.sdf-field.inside-outside {True,False}                                                           │
│                         Whether to revert signed distance value, set to True for indoor scene (default: True)    │
│ --pipeline.model.sdf-field.weight-norm {True,False}                                                              │
│                         Whether to use weight norm for linear layer (default: True)                              │
│ --pipeline.model.sdf-field.use-grid-feature {True,False}                                                         │
│                         Whether to use multi-resolution feature grids (default: True)                            │
│ --pipeline.model.sdf-field.divide-factor FLOAT                                                                   │
│                         Normalization factor for multi-resolution grids (default: 2.0)                           │
│ --pipeline.model.sdf-field.beta-init FLOAT                                                                       │
│                         Init learnable beta value for transformation of sdf to density (default: 0.8)            │
│ --pipeline.model.sdf-field.encoding-type {hash,periodic,tensorf_vm}                                              │
│                         (default: hash)                                                                          │
│ --pipeline.model.sdf-field.num-levels INT                                                                        │
│                         Number of encoding levels (default: 16)                                                  │
│ --pipeline.model.sdf-field.max-res INT                                                                           │
│                         Maximum resolution of the encoding (default: 2048)                                       │
│ --pipeline.model.sdf-field.base-res INT                                                                          │
│                         Base resolution of the encoding (default: 16)                                            │
│ --pipeline.model.sdf-field.log2-hashmap-size INT                                                                 │
│                         Size of the hash map (default: 19)                                                       │
│ --pipeline.model.sdf-field.features-per-level INT                                                                │
│                         Number of features per encoding level (default: 2)                                       │
│ --pipeline.model.sdf-field.use-hash {True,False}                                                                 │
│                         Whether to use hash encoding (default: True)                                             │
│ --pipeline.model.sdf-field.smoothstep {True,False}                                                               │
│                         Whether to use the smoothstep function (default: True)                                   │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─ pipeline.model.proposal-net-args-list.0 options ────────────────────────────────────────────────────────────────╮
│ --pipeline.model.proposal-net-args-list.0.hidden-dim INT                                                         │
│                         (default: 16)                                                                            │
│ --pipeline.model.proposal-net-args-list.0.log2-hashmap-size INT                                                  │
│                         (default: 17)                                                                            │
│ --pipeline.model.proposal-net-args-list.0.num-levels INT                                                         │
│                         (default: 5)                                                                             │
│ --pipeline.model.proposal-net-args-list.0.max-res INT                                                            │
│                         (default: 64)                                                                            │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─ pipeline.model.proposal-net-args-list.1 options ────────────────────────────────────────────────────────────────╮
│ --pipeline.model.proposal-net-args-list.1.hidden-dim INT                                                         │
│                         (default: 16)                                                                            │
│ --pipeline.model.proposal-net-args-list.1.log2-hashmap-size INT                                                  │
│                         (default: 17)                                                                            │
│ --pipeline.model.proposal-net-args-list.1.num-levels INT                                                         │
│                         (default: 5)                                                                             │
│ --pipeline.model.proposal-net-args-list.1.max-res INT                                                            │
│                         (default: 256)                                                                           │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─ optimizers.proposal-networks.optimizer options ─────────────────────────────────────────────────────────────────╮
│ Basic optimizer config with Adam                                                                                 │
│ ──────────────────────────────────────────────────────────────────────────────────────────────────────────────── │
│ --optimizers.proposal-networks.optimizer.lr FLOAT                                                                │
│                         The learning rate to use. (default: 0.01)                                                │
│ --optimizers.proposal-networks.optimizer.eps FLOAT                                                               │
│                         The epsilon value to use. (default: 1e-15)                                               │
│ --optimizers.proposal-networks.optimizer.max-norm {None}|FLOAT                                                   │
│                         The max norm to use for gradient clipping. (default: None)                               │
│ --optimizers.proposal-networks.optimizer.weight-decay FLOAT                                                      │
│                         The weight decay to use. (default: 0)                                                    │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─ optimizers.proposal-networks.scheduler options ─────────────────────────────────────────────────────────────────╮
│ Config for multi step scheduler where lr decays by gamma every milestone                                         │
│ ──────────────────────────────────────────────────────────────────────────────────────────────────────────────── │
│ --optimizers.proposal-networks.scheduler.max-steps INT                                                           │
│                         The maximum number of steps. (default: 20001)                                            │
│ --optimizers.proposal-networks.scheduler.gamma FLOAT                                                             │
│                         The learning rate decay factor. (default: 0.33)                                          │
│ --optimizers.proposal-networks.scheduler.milestones [INT [INT ...]]                                              │
│                         The milestone steps at which to decay the learning rate. (default: 10000 1500 18000)     │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─ optimizers.fields.optimizer options ────────────────────────────────────────────────────────────────────────────╮
│ Basic optimizer config with Adam                                                                                 │
│ ──────────────────────────────────────────────────────────────────────────────────────────────────────────────── │
│ --optimizers.fields.optimizer.lr FLOAT                                                                           │
│                         The learning rate to use. (default: 0.0005)                                              │
│ --optimizers.fields.optimizer.eps FLOAT                                                                          │
│                         The epsilon value to use. (default: 1e-15)                                               │
│ --optimizers.fields.optimizer.max-norm {None}|FLOAT                                                              │
│                         The max norm to use for gradient clipping. (default: None)                               │
│ --optimizers.fields.optimizer.weight-decay FLOAT                                                                 │
│                         The weight decay to use. (default: 0)                                                    │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─ optimizers.fields.scheduler options ────────────────────────────────────────────────────────────────────────────╮
│ Config for cosine decay schedule                                                                                 │
│ ──────────────────────────────────────────────────────────────────────────────────────────────────────────────── │
│ --optimizers.fields.scheduler.warm-up-end INT                                                                    │
│                         Iteration number where warmp ends (default: 500)                                         │
│ --optimizers.fields.scheduler.learning-rate-alpha FLOAT                                                          │
│                         Learning rate alpha value (default: 0.05)                                                │
│ --optimizers.fields.scheduler.max-steps INT                                                                      │
│                         The maximum number of steps. (default: 20001)                                            │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─ optimizers.field-background.optimizer options ──────────────────────────────────────────────────────────────────╮
│ Basic optimizer config with Adam                                                                                 │
│ ──────────────────────────────────────────────────────────────────────────────────────────────────────────────── │
│ --optimizers.field-background.optimizer.lr FLOAT                                                                 │
│                         The learning rate to use. (default: 0.0005)                                              │
│ --optimizers.field-background.optimizer.eps FLOAT                                                                │
│                         The epsilon value to use. (default: 1e-15)                                               │
│ --optimizers.field-background.optimizer.max-norm {None}|FLOAT                                                    │
│                         The max norm to use for gradient clipping. (default: None)                               │
│ --optimizers.field-background.optimizer.weight-decay FLOAT                                                       │
│                         The weight decay to use. (default: 0)                                                    │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─ optimizers.field-background.scheduler options ──────────────────────────────────────────────────────────────────╮
│ Config for cosine decay schedule                                                                                 │
│ ──────────────────────────────────────────────────────────────────────────────────────────────────────────────── │
│ --optimizers.field-background.scheduler.warm-up-end INT                                                          │
│                         Iteration number where warmp ends (default: 500)                                         │
│ --optimizers.field-background.scheduler.learning-rate-alpha FLOAT                                                │
│                         Learning rate alpha value (default: 0.05)                                                │
│ --optimizers.field-background.scheduler.max-steps INT                                                            │
│                         The maximum number of steps. (default: 20001)                                            │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─ optional subcommands ───────────────────────────────────────────────────────────────────────────────────────────╮
│ Specifies the dataparser used to unpack the data.  (default: sdfstudio-data)                                     │
│ ──────────────────────────────────────────────────────────────────────────────────────────────────────────────── │
│ [{nerfstudio-data,minimal-parser,arkit-data,blender-data,instant-ngp-data,nuscenes-data,dnerf-data,phototourism… │
│     nerfstudio-data                                                                                              │
│     minimal-parser                                                                                               │
│     arkit-data                                                                                                   │
│     blender-data                                                                                                 │
│     instant-ngp-data                                                                                             │
│     nuscenes-data                                                                                                │
│     dnerf-data                                                                                                   │
│     phototourism-data                                                                                            │
│     dycheck-data                                                                                                 │
│     scannet-data                                                                                                 │
│     sdfstudio-data                                                                                               │
│     nerfosr-data                                                                                                 │
│     sitcoms3d-data                                                                                               │
│     scannetpp-data                                                                                               │
│     colmap                                                                                                       │          ╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯

```



### 3. Pipelines

参考：[官方文档](https://docs.nerf.studio/developer_guides/pipelines/index.html)

![pipeline figure](https://cdn.jsdelivr.net/gh/Fernweh-yang/ImageHosting@main/img/nerfstudio_pipeline.png)

NerfStudio的目标就是把所有的nerf算法实现流程都用上面这个pipeline来实现，这个Pipeline主要由2个模块组成：

1. **DataManager**

   负责加载局数据并生成光线RayBundle和光线真值RayGT

   - 光线RayBundle描述了光线起点和方向，是模型Model的输入，在训练training和推断inference阶段都需要。
   - 光线真值RayGT包含了必要的GT值(pixel values等)，只在训练时使用，用于在loss dict中计算loss

   目前`nerfstudio`中所有的nerf算法用的都是`VanillaDataManager()`

2. **DataParser**

   dataparser返回值是`DataparserOutputs`类，会把各种数据转换成一个轻量级的通用格式，最后会被Pytorch的`Datasets`和`Dataloaders`读取。

   `nerfstudio`中各个算法都有各自的`DataParser`类实现

3. **Models**

   model也就是不同nerf论文中method部分的实现。

   model会在输入的RayBundle上采样，并返回每个光线的渲染值。

4. **Field**

   Field是model的一个组成部分，用于将一个空间部分(a region of space)和一些量(quantity)联系起来。通常输入是3d location和 viewing direction，输出是密度density和颜色color

5. **Pipeline**

   pipeline包含所有运行一个nerf算法的代码。


### 4. 使用自定义的数据集

根据[文档介绍](https://docs.nerf.studio/quickstart/custom_dataset.html)在nerfstudio中使用其他数据集，需要用他们的[scripts](https://github.com/nerfstudio-project/nerfstudio/blob/main/nerfstudio/scripts/process_data.py)完成如下操作：

1. 使用colmap来计算相机位姿
2. 转换成nerfstudio可以读取的格式

命令：[参考](https://docs.nerf.studio/reference/cli/ns_process_data.html#images)

```
ns-process-data {video,images,polycam,record3d} --data {DATA_PATH} --output-dir {PROCESSED_DATA_DIR}
```



## NerfAcc

根据[git官网](https://github.com/nerfstudio-project/nerfacc)介绍：它是一个基于Pytorch的nerf训练和推断加速库

- 注意：基于2023/04/04之前nerfacc<=0.3.5版本开发的一些api和后面的版本api有变化，如果跑不通需要查看[CHANGELOG](https://github.com/nerfstudio-project/nerfacc/blob/master/CHANGELOG.md)

## jaxtyping

在nerfstudio中有用到这个库。

根据[git官网](https://github.com/google/jaxtyping)介绍：是一个用于给[jax](https://jax.readthedocs.io/en/latest/index.html)数组类型, pytorch, numpy和 tensorflow做 **标注(annotate**) 和 **运行时类型检测(runtime type-checking** ) 的工具

> Just After eXceution（**JAX**）是CPU、GPU和TPU上的NumPy。它是一个用于高性能数值计算的Python库，特别是机器学习研究。

[文档](https://docs.kidger.site/jaxtyping/)

- 安装：

  ```
  pip install jaxtyping
  ```

- 例子：

  ```python
  # 在函数定义时写好，相当于在为数据类型做标注annotate
  from jaxtyping import Array, Float, PyTree, jaxtyped
  
  # 加了装饰器后，当调用下面函数时，会自动检查数据类型是否一致runtime type-checking
  # Use your favourite typechecker: usually one of the two lines below.
  from typeguard import typechecked as typechecker
  from beartype import beartype as typechecker
  
  
  # 例子1： 创建一个dtype=float类型的数组array，数组形状shape=dim1 x dim2
  # Accepts floating-point 2D arrays with matching axes
  # 形状可以是固定的数字如"28 28"，也可以是像这里的变量
  @jaxtyped(typechecker=typechecker)
  def matrix_multiply(x: Float[Array, "dim1 dim2"],
                      y: Float[Array, "dim2 dim3"]
                    ) -> Float[Array, "dim1 dim3"]:
      ...
  
  # 例子2： 为NumPy, TensorFlow, and PyTorch做类型检测：
  Float[np.ndarray, "..."]
  Float[tf.Tensor, "..."]
  Float[torch.Tensor, "..."]
      
      
  # 例子3： 创建一个PyTree类型的变量，int表示这个树的叶子数据类型
  def accepts_pytree_of_ints(x: PyTree[int]):
      ...
  
  def accepts_pytree_of_arrays(x: PyTree[Float[Array, "batch c1 c2"]]):
      ...
  ```

  

## toml

`.toml` 文件是一种配置文件格式，其名称来源于 "Tom's Obvious Minimal Language"，是一种易于阅读和编写的数据序列化语言。

Toml 旨在成为配置文件的一种简洁而直观的格式，它采用了键值对的结构，并支持嵌套、数组和其他复杂数据结构。

例子：

```python
import toml

# 例1：读取 Toml 文件
with open('your_file.toml', 'r') as file:
    data = toml.load(file)
print(data)

# 例2： 将字典写入Toml文件
data = {'key1': 'value1', 'key2': {'nested_key': 'nested_value'}}
with open('output_file.toml', 'w') as file:
    toml.dump(data, file)
```



## SSDNeRF

[SSDNeRF](https://github.com/Lakonik/SSDNeRF)

各种基于SSD的nerf算法如[UniSurf](https://github.com/autonomousvision/unisurf), [VolSDF](https://github.com/lioryariv/volsdf), and [NeuS](https://github.com/Totoro97/NeuS)主要差别在于：

1. 射线上的点是如何被采样的
2. 在体渲染当中SDF值是如何被使用的

### 1. 安装

### 2. 使用

- 可视化

  ```shell
  python demo/ssdnerf_gui.py /home/yang/Desktop/ssd/SSDNeRF/configs/paper_cfgs/ssdnerf_cars_recons1v.py /home/yang/Desktop/ssd/trainedModel/ssdnerf_cars_recons1v_80k_emaonly.pth --fp16
  ```

- 输出图片

  ```
  python debug_output_image.py /home/yang/Desktop/ssd/SSDNeRF/configs/paper_cfgs/ssdnerf_cars_recons1v.py /home/yang/Desktop/ssd/trainedModel/ssdnerf_cars_recons1v_80k_emaonly.pth --fp16
  ```

- test

  ```
  python test.py /home/yang/Desktop/ssd/SSDNeRF/configs/paper_cfgs/ssdnerf_cars_recons1v.py /home/yang/Desktop/ssd/trainedModel/ssdnerf_cars_recons1v_80k_emaonly.pth --gpu-ids 0
  ```

- test and output

  ```
  python test_and_output.py /home/yang/Desktop/ssd/SSDNeRF/configs/paper_cfgs/ssdnerf_cars_recons1v.py /home/yang/Desktop/ssd/trainedModel/ssdnerf_cars_recons1v_80k_emaonly.pth --gpu-ids 0
  ```

  